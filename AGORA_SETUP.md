# Agora Video Conference Setup Guide

## Overview

The VideoConference component has been successfully implemented using Agora's React Native SDK. This allows coaches to conduct live video classes with their learners.

## Installation

The `react-native-agora` package has been installed:
```bash
npm install react-native-agora
```

## Environment Configuration

Add your Agora App ID to your `.env` file:

```
EXPO_PUBLIC_AGORA_APP_ID=your_agora_app_id_here
```

**Note:** Get your Agora App ID from [Agora Console](https://console.agora.io/)

## Component Structure

### VideoConference Component
**Location:** `components/common/VideoConference/index.tsx`

**Props:**
```typescript
interface VideoConferenceProps {
  isVisible: boolean;           // Controls modal visibility
  onClose: () => void;         // Callback when closing
  channelName: string;         // Agora channel name
  token: string;               // Agora authentication token
  uid: number;                 // User ID (coach ID)
  agoraAppId: string;          // Agora App ID
}
```

## Usage in SessionDetailModal

The VideoConference component is integrated into the SessionDetailModal:

```tsx
import VideoConference from "../../common/VideoConference";

// Inside the component:
<VideoConference
  isVisible={isVCVisible}
  onClose={() => setIsVCVisible(false)}
  channelName={channelName}
  token={vcToken}
  uid={user?.id || 0}
  agoraAppId={process.env.EXPO_PUBLIC_AGORA_APP_ID || ""}
/>
```

## Features

### Video Conference Capabilities
- ‚úÖ Real-time audio/video streaming
- ‚úÖ Microphone toggle (on/off)
- ‚úÖ Camera toggle (on/off)
- ‚úÖ End call functionality
- ‚úÖ Real-time participant count
- ‚úÖ Connection status feedback

### UI/UX
- **Dark Theme:** Professional black background
- **Control Panel:** Easy-to-access audio/video toggles and end call button
- **Local Video Preview:** Floating preview showing your own connection (bottom-right corner)
- **Remote Users:** Grid layout showing connected learners
- **Loading State:** Connection progress indicator
- **Empty State:** Shows when waiting for learners to join

## Integration Flow

### 1. Session Detail Modal
When a coach opens a session and clicks "Tham gia l·ªõp h·ªçc tr·ª±c tuy·∫øn" (Join Video Class):

```typescript
const handleJoinVideoConference = async () => {
  // Fetch channel details from backend
  const details = await videoConferenceService.getVideoConferenceDetails(
    sessionData.courseId
  );
  
  // Extract channel name and token
  setChannelName(details.channelName);
  setVcToken(details.vcToken);
  
  // Show VideoConference modal
  setIsVCVisible(true);
};
```

### 2. VideoConference Component
Once the modal is visible:
- Agora engine is initialized with app ID
- User joins the channel using token and channel name
- Real-time events (UserJoined, UserOffline) are handled
- Audio/video can be toggled independently
- End call leaves the channel

## Backend Requirements

Your backend API should provide:

**Endpoint:** `GET /v1/video-conference/details/{courseId}`

**Response:**
```json
{
  "channelName": "course_123",
  "vcToken": "token_string_from_agora",
  "appId": "agora_app_id"
}
```

**Note:** Tokens must be generated server-side using Agora's token generation library for security.

## Controls

| Control | Function | Icon |
|---------|----------|------|
| Microphone Button | Toggle audio on/off | üé§ |
| Camera Button | Toggle video on/off | üìπ |
| End Call Button | Leave channel and close modal | üìû (Red) |

## Styling

All styling uses the mobile-first design system:
- **Colors:** Professional green (#059669) for active states, dark grays for UI
- **Button Sizing:** 56px diameter for easy touch
- **Dark Theme:** #000000 background for reduced eye strain during long sessions
- **Responsive Layout:** Adapts to different device sizes

## Error Handling

The component includes comprehensive error handling:

```typescript
// Connection errors
Alert.alert("L·ªói k·∫øt n·ªëi", "Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi l·ªõp h·ªçc tr·ª±c tuy·∫øn")

// Initialization errors
Alert.alert("L·ªói", "Kh√¥ng th·ªÉ kh·ªüi t·∫°o video conference")

// All errors logged to console for debugging
 "Failed to initialize Agora:", error)
```

## Console Logging

For debugging, enable console logging in the Agora engine:

```typescript
engine.initialize({
  appId: agoraAppId,
  logConfig: {
    filePath: "",
    level: 0,  // 0 = INFO level
  },
});
```

Check console logs for:
- `User X joined` - Remote user connected
- `User X offline` - Remote user disconnected
- `Joined channel` - Successfully joined
- `Agora error` - Connection issues

## Testing

### Prerequisites
1. Valid Agora App ID in `.env`
2. Tokens generated by your backend API
3. Multiple devices or emulators for testing

### Test Scenario
1. Coach opens a session
2. Click "Tham gia l·ªõp h·ªçc tr·ª±c tuy·∫øn" button
3. Wait for "ƒêang k·∫øt n·ªëi..." loading screen
4. Mock learner joins (or use another device)
5. Test microphone toggle
6. Test camera toggle
7. Test end call

## Performance Considerations

- **Resolution:** 360x640 (optimized for mobile)
- **Frame Rate:** 15 FPS (reduces bandwidth)
- **Bitrate:** 1130 kbps (mobile-friendly)
- **Auto Subscribe:** Both audio and video enabled

These settings optimize for:
- Lower bandwidth usage
- Reduced device heat
- Better battery life
- Smooth performance on older devices

## Troubleshooting

### No video appears
- Verify Agora App ID is correct in `.env`
- Check token is valid and not expired
- Verify camera permissions are granted
- Check that channel name matches on both sides

### No audio
- Verify microphone permissions are granted
- Check that audio is not muted locally
- Verify back-end audio encoding matches

### Connection drops
- Check network stability
- Verify token hasn't expired
- Check Agora service status

### Learners can't join
- Verify they have correct channel name
- Verify they have valid token
- Check their Agora UID is different from coach

## Security Notes

‚ö†Ô∏è **Never commit Agora App ID to version control**
- Use `.env` file (not in git)
- Rotate tokens frequently
- Generate tokens server-side only
- Validate user permissions before generating tokens

## Future Enhancements

Potential features for future versions:
- Screen sharing
- Recording sessions
- Chat functionality
- Virtual backgrounds
- Session transcription
- Advanced analytics

## References

- [Agora React Native Documentation](https://docs.agora.io/en/video-calling/enable-features/basic-features/react-native-sdk)
- [Agora Token Generation](https://docs.agora.io/en/video-calling/develop/authentication-workflow)
- [Agora API Reference](https://docs.agora.io/en/video-calling/get-started/sdk-reference)

## Support

For issues or questions:
1. Check console logs for Agora error codes
2. Verify Agora App ID and tokens
3. Review backend video conference service implementation
4. Contact Agora support for SDK-specific issues
